// --- CONFIGURATION ---
const STREAM_ID = 'shloopky-live-broadcaster'; 
const peer = new Peer(STREAM_ID);

// Replace these with your actual Supabase keys!
const SUPABASE_URL = 'https://your-project.id.supabase.co';
const SUPABASE_KEY = 'your-anon-key';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let localStream = null;

// --- 1. LOGIN & AUTH ---
function handleAuth() {
    const userField = document.getElementById('user-in');
    const passField = document.getElementById('pass-in');
    const username = userField.value.trim();
    const password = passField.value;

    // Admin override for you
    if (username === "Shloopky" && password === "admin123") {
        currentUser = "Shloopky";
    } else {
        currentUser = username || "Guest";
    }

    // Update UI
    document.getElementById('auth-overlay').style.display = "none";
    document.getElementById('user-display').innerHTML = `Welcome, <strong>${currentUser}</strong>! ðŸ«§`;

    // Permissions
    if (currentUser === "Shloopky") {
        document.getElementById('admin-tools').style.display = "block";
        document.getElementById('status-text').innerText = "Broadcaster Ready";
    } else {
        connectToStream(); // Viewers try to find Shloopky's screen
    }
    
    loadOldMessages(); // Pull chat history from Supabase
}

// --- 2. GLOBAL STREAMING (PeerJS) ---
async function initiateGlobalStream() {
    try {
        localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        document.getElementById('global-player').srcObject = localStream;
        document.getElementById('live-indicator').style.display = "block";
        document.getElementById('start-btn').style.display = "none";
        document.getElementById('stop-btn').style.display = "inline-block";
        
        peer.on('call', call => call.answer(localStream)); // Send video to whoever joins
    } catch(e) {
        alert("Could not share screen.");
    }
}

function connectToStream() {
    const call = peer.call(STREAM_ID, null); 
    call.on('stream', remoteStream => {
        document.getElementById('global-player').srcObject = remoteStream;
        document.getElementById('live-indicator').style.display = "block";
    });
}

// --- 3. REAL-TIME CHAT (Supabase) ---
async function sendChat() {
    const input = document.getElementById('chat-input');
    const val = input.value.trim();
    if (!val) return;

    await supabase.from('messages').insert([{ username: currentUser, content: val }]);
    input.value = "";
}

// Listen for new messages from anyone on the web
supabase
    .channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        displayMessage(payload.new.username, payload.new.content);
    })
    .subscribe();

function displayMessage(user, content) {
    const msg = document.createElement('div');
    msg.className = "chat-msg";
    msg.innerHTML = `<b>${user}:</b> ${content}`;
    const box = document.getElementById('chat-messages');
    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;
}

async function loadOldMessages() {
    const { data } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
    if(data) data.forEach(m => displayMessage(m.username, m.content));
}

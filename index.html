<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AeroChat Social</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="auth-overlay" class="overlay" style="display: flex; position: fixed; width: 100%; height: 100%; z-index: 10000; background: var(--glass); backdrop-filter: blur(30px); justify-content: center; align-items: center;">
    <div class="glass-panel" style="padding: 40px; text-align: center; border-radius: 24px; background: white; width: 320px;">
        <h2 style="color: var(--accent);">Welcome to Aero</h2>
        <p style="color: #666; font-size: 14px;">Connect with GitHub to save your progress</p>
        <button class="aero-btn" onclick="loginWithGitHub()" style="width: 100%; padding: 12px; border: none; border-radius: 10px; background: #24292e; color: white; cursor: pointer; font-weight: 600;">Login with GitHub</button>
    </div>
</div>

<div id="invite-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10001; background:white; padding:25px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
    <h3>Join a Server</h3>
    <input type="text" id="invite-in" placeholder="Enter Invite Code" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
    <button class="aero-btn" onclick="joinServer()" style="width:100%;">Join</button>
</div>

<nav class="server-rail">
    <div class="server-icon active" onclick="switchServer('home')">üè†</div>
    <div id="server-list"></div>
    <div class="server-icon" style="background: rgba(0,255,100,0.1); color: green;" onclick="toggleInviteModal()">+</div>
</nav>

<aside class="sidebar-channels">
    <div style="padding: 20px; font-weight: 800; font-size: 18px; color: var(--accent);">AeroChat</div>
    <div id="channel-list">
        <div class="channel-item active"># general</div>
        <div class="channel-item"># gaming</div>
        <div class="channel-item"># development</div>
    </div>
    
    <div style="margin-top:auto; padding: 15px; display:flex; align-items:center; gap:10px; background: rgba(0,0,0,0.03);">
        <img id="my-pfp" src="" class="msg-pfp" style="width:32px; height:32px;">
        <span id="my-username" style="font-size: 13px; font-weight: 600;">User</span>
    </div>
</aside>

<main class="chat-window">
    <div id="chat-messages"></div>
    <div class="input-area">
        <input type="text" id="chat-in" class="input-box" placeholder="Message #general..." onkeypress="if(event.key==='Enter') sendChat()">
    </div>
</main>

<script>
    const SUPABASE_URL = 'YOUR_URL';
    const SUPABASE_KEY = 'YOUR_KEY';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null;
    let currentServer = 'home';

    // --- GITHUB AUTH ---
    async function loginWithGitHub() {
        const { error } = await _supabase.auth.signInWithOAuth({
            provider: 'github'
        });
    }

    // Check login state on load
    window.onload = async () => {
        const { data } = await _supabase.auth.getUser();
        if (data.user) {
            user = data.user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('my-pfp').src = user.user_metadata.avatar_url;
            document.getElementById('my-username').innerText = user.user_metadata.full_name;
            loadServers();
            loadMessages();
        }
    };

    // --- CHAT LOGIC ---
    async function loadMessages() {
        const { data } = await _supabase
            .from('messages')
            .select('*')
            .eq('server_id', currentServer)
            .order('created_at', { ascending: true });
        
        const box = document.getElementById('chat-messages');
        box.innerHTML = '';
        if (data) data.forEach(msg => appendMessage(msg));
        box.scrollTop = box.scrollHeight;
    }

    async function sendChat() {
        const input = document.getElementById('chat-in');
        if (!input.value.trim()) return;

        const msgObj = {
            profile_id: user.id,
            username: user.user_metadata.full_name,
            pfp: user.user_metadata.avatar_url,
            content: input.value,
            server_id: currentServer
        };

        await _supabase.from('messages').insert([msgObj]);
        input.value = '';
    }

    function appendMessage(msg) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `
            <img src="${msg.pfp}" class="msg-pfp">
            <div class="msg-body">
                <span class="msg-user">${msg.username}</span>
                <span class="msg-text">${msg.content}</span>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // Real-time listener
    _supabase.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        if (payload.new.server_id === currentServer) {
            appendMessage(payload.new);
        }
    }).subscribe();

    // --- INVITE SYSTEM ---
    function toggleInviteModal() {
        const m = document.getElementById('invite-modal');
        m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }

    async function joinServer() {
        const code = document.getElementById('invite-in').value;
        const { data, error } = await _supabase.from('servers').select('*').eq('invite_code', code).single();
        
        if (data) {
            // Logic to add server to user's list
            alert(`Joined ${data.name}!`);
            toggleInviteModal();
            loadServers();
        } else {
            alert("Invalid Code");
        }
    }
</script>
</body>
</html>

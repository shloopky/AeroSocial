<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AeroStream</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { margin: 0; font-family: Arial, sans-serif; background: #e3f2fd; }
.glass-panel { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 16px; padding: 16px; }
.overlay { position: fixed; inset: 0; background: rgba(187,222,251,0.7); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.aero-btn { padding: 10px 16px; border-radius: 10px; border: none; background: #0078d7; color: white; cursor: pointer; }
.main-layout { display: flex; gap: 20px; padding: 20px; }
.stream-container { flex: 2; }
.chat-sidebar { flex: 1; }
video { width: 100%; background: black; border-radius: 12px; }
#chat-messages { height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.chat-msg { background: white; padding: 10px 14px; border-radius: 14px; }
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth-overlay" class="overlay">
  <div class="glass-panel">
    <h2>Aero Login</h2>
    <input id="user-in" placeholder="Username"><br><br>
    <input id="pass-in" placeholder="Admin Password (Shloopky only)" type="password"><br><br>
    <button class="aero-btn" onclick="handleAuth()">Join</button>
  </div>
</div>

<header style="padding:12px 20px; display:flex; justify-content:space-between;">
  <div><b>AeroStream</b></div>
  <div id="user-display"></div>
</header>

<div class="main-layout">

<div class="stream-container glass-panel">
  <div id="live-indicator" style="display:none;color:red;">● LIVE</div>
  <video id="global-player" autoplay playsinline></video>

  <div id="admin-tools" style="display:none;margin-top:10px;">
    <button class="aero-btn" onclick="initiateGlobalStream()">Start Stream</button>
  </div>

  <div id="viewer-tools" style="display:none;margin-top:10px;">
    <button class="aero-btn" onclick="forceReconnect()">Reconnect</button>
  </div>

  <div id="status-text">Waiting for Shloopky…</div>
</div>

<div class="chat-sidebar glass-panel">
  <div id="chat-messages"></div>
  <input id="chat-input" placeholder="Message…" onkeypress="if(event.key==='Enter')sendChat()">
  <button class="aero-btn" onclick="sendChat()">Send</button>
</div>

</div>

<script>
/* ---------------- CONFIG ---------------- */
const ADMIN_NAME = "Shloopky";
const ADMIN_PASSWORD = "ADMIN123";

const SUPABASE_URL = "https://nrpiojdaltgfgswvhrys.supabase.co";
const SUPABASE_KEY = "sb_publishable_nu-if7EcpRJkKD9bXM97Rg__X3ELLW7";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

/* ---------------- STATE ---------------- */
let currentUser = null;
let localStream = null;
let peerConnections = {};
let pendingViewers = new Set();

/* ---------------- AUTH ---------------- */
function handleAuth() {
  const user = user-in.value.trim();
  const pass = pass-in.value;

  if (!user) return alert("Enter a username");

  if (user === ADMIN_NAME && pass !== ADMIN_PASSWORD) {
    return alert("Wrong admin password");
  }

  currentUser = user;
  auth-overlay.style.display = "none";
  user-display.innerHTML = `User: <b>${user}</b>`;

  if (user === ADMIN_NAME) {
    admin-tools.style.display = "block";
    global-player.muted = true;
  } else {
    viewer-tools.style.display = "block";
    sendSignal(ADMIN_NAME, "join-request", "{}");
  }
}

/* ---------------- SIGNALING ---------------- */
supa.channel("signaling")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"signaling"}, async p=>{
  const d = p.new;
  if (d.to_user !== currentUser) return;

  if (d.type === "join-request" && currentUser === ADMIN_NAME) {
    if (localStream) createPeerConnection(d.from_user);
    else pendingViewers.add(d.from_user);
  }

  if (d.type === "offer") handleOffer(d.from_user, JSON.parse(d.message));
  if (d.type === "answer" && peerConnections[d.from_user])
    peerConnections[d.from_user].setRemoteDescription(JSON.parse(d.message));
  if (d.type === "candidate" && peerConnections[d.from_user])
    peerConnections[d.from_user].addIceCandidate(JSON.parse(d.message));
}).subscribe();

/* ---------------- WEBRTC ---------------- */
async function createPeerConnection(viewer) {
  if (peerConnections[viewer] || !localStream) return;

  const pc = new RTCPeerConnection(rtcConfig);
  peerConnections[viewer] = pc;

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.onicecandidate = e=>{
    if(e.candidate) sendSignal(viewer,"candidate",JSON.stringify(e.candidate));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  sendSignal(viewer,"offer",JSON.stringify(offer));
}

async function handleOffer(admin, offer) {
  const pc = new RTCPeerConnection(rtcConfig);
  peerConnections[admin] = pc;

  pc.ontrack = e=>{
    if (!global-player.srcObject) {
      global-player.srcObject = e.streams[0];
      global-player.play().catch(()=>{});
      live-indicator.style.display="block";
      status-text.innerText="LIVE";
    }
  };

  pc.onicecandidate = e=>{
    if(e.candidate) sendSignal(admin,"candidate",JSON.stringify(e.candidate));
  };

  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  sendSignal(admin,"answer",JSON.stringify(answer));
}

/* ---------------- STREAM ---------------- */
async function initiateGlobalStream() {
  localStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
  global-player.srcObject = localStream;
  live-indicator.style.display="block";
  status-text.innerText="Streaming";

  for (const v of pendingViewers) createPeerConnection(v);
  pendingViewers.clear();
}

/* ---------------- UTILS ---------------- */
function forceReconnect() {
  Object.values(peerConnections).forEach(pc=>pc.close());
  peerConnections = {};
  global-player.srcObject = null;
  sendSignal(ADMIN_NAME,"join-request","{}");
}

async function sendSignal(to,type,msg){
  await supa.from("signaling").insert([{from_user:currentUser,to_user:to,type,message:msg}]);
}

/* ---------------- CHAT ---------------- */
async function sendChat(){
  if(!chat-input.value.trim())return;
  await supa.from("messages").insert([{username:currentUser,content:chat-input.value}]);
  chat-input.value="";
}
supa.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},p=>{
  const d=document.createElement("div");
  d.className="chat-msg";
  d.innerHTML=`<b>${p.new.username}:</b> ${p.new.content}`;
  chat-messages.appendChild(d);
  chat-messages.scrollTop=chat-messages.scrollHeight;
}).subscribe();
</script>

</body>
</html>
